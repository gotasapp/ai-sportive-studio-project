# üîç Vision Analyze Image Endpoint Strategy

## ‚úÖ Objetivo

Implementar um endpoint FastAPI `/analyze-image` robusto que:
- Envie imagem + prompt ao modelo Vision (via OpenRouter)
- Valide a resposta JSON antes de retornar ao frontend
- Garanta que sempre retornemos dados estruturados v√°lidos

## ‚úÖ Exemplo de Endpoint /analyze-image com valida√ß√£o

```python
# app/api/analyze_image.py

from fastapi import APIRouter, HTTPException, Request
from pydantic import BaseModel
import httpx
import json

router = APIRouter()

# üîê Configure seu modelo e chave
OPENROUTER_API_KEY = "your-openrouter-key"
VISION_MODEL = "openai/gpt-4-vision-preview"

# ‚úÖ Modelo da requisi√ß√£o
class AnalyzeImageRequest(BaseModel):
    image_base64: str
    prompt: str
    model: str = VISION_MODEL
    type: str = "vision-analysis"

# ‚úÖ Endpoint POST
@router.post("/analyze-image")
async def analyze_image(request: AnalyzeImageRequest):
    try:
        headers = {
            "Authorization": f"Bearer {OPENROUTER_API_KEY}",
            "Content-Type": "application/json"
        }

        body = {
            "model": request.model,
            "messages": [
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": request.prompt.strip()
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{request.image_base64}"
                            }
                        }
                    ]
                }
            ],
            "max_tokens": 1000
        }

        async with httpx.AsyncClient(timeout=30.0) as client:
            response = await client.post("https://openrouter.ai/api/v1/chat/completions", json=body, headers=headers)
            response.raise_for_status()
            result = response.json()

        # ‚úÖ Extrair e validar JSON da resposta
        content = result["choices"][0]["message"]["content"].strip()

        # Remove blocos ```json``` se houver
        if content.startswith("```json"):
            content = content[7:]
        if content.endswith("```"):
            content = content[:-3]

        try:
            parsed_json = json.loads(content)
        except json.JSONDecodeError:
            raise HTTPException(status_code=400, detail="Resposta do modelo n√£o est√° em formato JSON v√°lido.")

        return {
            "success": True,
            "analysis": parsed_json
        }

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Erro ao processar imagem: {str(e)}")
```

## ‚úÖ Como usar no seu app

Esse endpoint aceita:
- **prompt** gerado via `get_structured_analysis_prompt`
- **image_base64** vinda do frontend
- Ele envia para o modelo Vision via OpenRouter
- **Valida a resposta**, removendo ```json e tentando `json.loads`
- **Retorna analysis** ao frontend como objeto estruturado

## ‚úÖ Requisitos

- Python ‚â• 3.9
- FastAPI
- httpx (`pip install httpx`)

Voc√™ pode conectar esse endpoint no seu main.py:

```python
from app.api import analyze_image

app.include_router(analyze_image.router, prefix="/api")
```

## üîß Implementa√ß√£o no Nosso Sistema

### üìã **An√°lise da Nossa Arquitetura Atual:**

| **Arquivo Atual** | **Fun√ß√£o** | **Status** |
|-------------------|------------|------------|
| `api/main.py` | Backend principal com `/analyze-image` | ‚úÖ **J√Å EXISTE** |
| `src/app/api/vision-test/route.ts` | Frontend API que chama backend | ‚úÖ **J√Å EXISTE** |
| `api/vision_prompts/analysis_prompts.py` | Prompts JSON estruturados | ‚úÖ **REC√âM ATUALIZADO** |

### üéØ **Melhorias Necess√°rias:**

#### **1. VALIDA√á√ÉO JSON ROBUSTA no Backend Python**

**Arquivo:** `api/main.py` (fun√ß√£o existente)

```python
# MELHORAR a fun√ß√£o existente:
@app.post("/analyze-image")
async def analyze_image_endpoint(request: VisionAnalysisRequest):
    try:
        # ... c√≥digo existente ...
        
        # ‚úÖ ADICIONAR: Valida√ß√£o JSON robusta
        content = result.choices[0].message.content.strip()
        
        # Remove markdown code blocks
        if content.startswith("```json"):
            content = content[7:]
        if content.endswith("```"):
            content = content[:-3]
        content = content.strip()
        
        # Tenta fazer parse do JSON
        try:
            parsed_analysis = json.loads(content)
            
            # ‚úÖ VALIDA√á√ÉO ESPEC√çFICA: Verifica campos obrigat√≥rios
            required_fields = ["dominantColors", "pattern", "style", "view"]
            for field in required_fields:
                if field not in parsed_analysis:
                    print(f"‚ö†Ô∏è Campo obrigat√≥rio {field} n√£o encontrado, usando fallback")
                    return _generate_intelligent_fallback(request.sport, request.view)
            
            return GenerationResponse(
                success=True,
                analysis=parsed_analysis,  # ‚úÖ JSON j√° validado
                model_used=request.model,
                cost_estimate=0.01
            )
            
        except json.JSONDecodeError as e:
            print(f"‚ùå JSON inv√°lido retornado pelo modelo: {e}")
            return _generate_intelligent_fallback(request.sport, request.view)
            
    except Exception as e:
        print(f"‚ùå Erro na an√°lise: {e}")
        return _generate_intelligent_fallback(request.sport, request.view)

def _generate_intelligent_fallback(sport: str, view: str) -> dict:
    """Gera fallback inteligente baseado no esporte"""
    fallback_data = {
        "soccer": {
            "dominantColors": ["white", "blue"],
            "pattern": "solid color with minimal details",
            "numberStyle": {
                "font": "bold sans-serif",
                "fillPattern": "solid color",
                "outline": "white border"
            },
            "namePlacement": "centered above number",
            "collar": "round collar",
            "sleeves": "short sleeves",
            "style": "modern",
            "texture": "smooth fabric",
            "logos": "none",
            "view": view
        }
    }
    
    return GenerationResponse(
        success=True,
        analysis=fallback_data.get(sport, fallback_data["soccer"]),
        model_used="intelligent_fallback",
        cost_estimate=0
    )
```

#### **2. FUN√á√ÉO DE GERA√á√ÉO DALLE-3 OTIMIZADA**

**Adicionar ao `api/main.py`:**

```python
def generate_dalle_prompt(analysis_result: dict, player_name: str, player_number: str) -> str:
    """
    Gera prompt otimizado para DALL-E 3 baseado na an√°lise Vision
    """
    
    # Extrai dados da an√°lise com fallbacks seguros
    colors = ", ".join(analysis_result.get("dominantColors", ["white", "black"]))
    pattern = analysis_result.get("pattern", "solid design")
    style = analysis_result.get("style", "modern")
    texture = analysis_result.get("texture", "smooth fabric")
    collar = analysis_result.get("collar", "round collar")
    sleeves = analysis_result.get("sleeves", "short sleeves")
    
    # Extrai informa√ß√µes do n√∫mero se dispon√≠vel
    number_style = analysis_result.get("numberStyle", {})
    font = number_style.get("font", "bold")
    fill_pattern = number_style.get("fillPattern", "solid")
    outline = number_style.get("outline", "none")
    
    name_placement = analysis_result.get("namePlacement", "centered above the number")
    
    return f"""
Create a photorealistic image of a modern soccer jersey viewed from the back, with the following characteristics:

- Dominant colors: {colors}
- Jersey pattern: {pattern}
- Number style: font = {font}, fill pattern = {fill_pattern}, outline = {outline}
- Name placement: {name_placement}
- Collar: {collar}
- Sleeves: {sleeves}
- Overall style: {style}
- Texture: {texture}
- Logos: {analysis_result.get("logos", "none")}

Use the following player details:
- Name: **{player_name.upper()}**
- Number: **{player_number}**

Render the jersey in high quality, centered, on a plain white background, no mannequins, no brand logos, only the shirt.
"""

# Usar na gera√ß√£o:
@app.post("/generate", response_model=GenerationResponse)
async def generate_jersey_endpoint(request: ImageGenerationRequest):
    if request.generation_mode == 'vision_enhanced' and request.vision_analysis:
        # ‚úÖ Usar nova fun√ß√£o otimizada
        optimized_prompt = generate_dalle_prompt(
            request.vision_analysis,
            request.player_name,
            request.player_number
        )
        
        # Chamar DALL-E 3 com prompt otimizado
        image_base64 = await generate_with_dalle3(optimized_prompt, request.quality)
        
        return GenerationResponse(
            success=True,
            image_base64=image_base64,
            cost_usd=0.045
        )
```

#### **3. INTEGRA√á√ÉO COM FRONTEND EXISTENTE**

**No `src/app/api/vision-test/route.ts` (j√° existe, s√≥ melhorar):**

```typescript
// ‚úÖ J√° est√° implementado, mas podemos melhorar a valida√ß√£o:
const result = await response.json();

if (!result.success) {
  throw new Error(result.error || 'Vision analysis failed');
}

// ‚úÖ ADICIONAR: Valida√ß√£o no frontend tamb√©m
const analysis = result.analysis;
if (typeof analysis !== 'object' || !analysis.dominantColors) {
  console.warn('‚ö†Ô∏è An√°lise incompleta recebida, usando dados b√°sicos');
  // Fallback no frontend se necess√°rio
}

return NextResponse.json({
  success: true,
  analysis: analysis,
  model_used: result.model_used || model,
  validation: 'frontend_validated'
});
```

## üöÄ **Implementa√ß√£o Imediata**

### **Prioridades:**

1. **‚úÖ FEITO** - Prompts JSON estruturados
2. **üîß PR√ìXIMO** - Valida√ß√£o JSON robusta no `api/main.py`
3. **üé® PR√ìXIMO** - Fun√ß√£o `generate_dalle_prompt()` otimizada
4. **üß™ TESTAR** - Na p√°gina vision-test

### **Benef√≠cios Esperados:**

- **üéØ 100% JSON v√°lido** sempre retornado
- **üîí Fallbacks inteligentes** para casos de erro
- **üé® Prompts DALL-E otimizados** com base na an√°lise real
- **‚ö° Sistema robusto** que n√£o quebra com respostas inesperadas

**Quer que eu implemente essas melhorias no `api/main.py` agora?** üöÄ 